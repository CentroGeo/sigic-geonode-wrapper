# SPDX-FileCopyrightText: 2025 CentroGeo
# SPDX-FileContributor: C√©sar Benjam√≠n <cesarbenjamindotnet@gmail.com>
# SPDX-License-Identifier: Apache-2.0
#
# Descripci√≥n:
#   Workflow de GitHub Actions para CI/CD del proyecto
#   "SIGIC GeoNode Wrapper" en la rama `main`.
#   Incluye:
#     - Construcci√≥n de im√°genes Docker (GeoNode, GeoServer, NGINX, PostGIS, Let's Encrypt)
#     - Publicaci√≥n en GitHub Container Registry (GHCR)
#
#    Este workflow se activa en la rama `main`.
#    Las im√°genes se etiquetan con `latest`. Y son publicadas en GHCR para su uso en despliegues de producci√≥n.
#

name: Release SIGIC Stack

on:
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_ROOT: ${{ github.repository }}

  NGINX_BASE_IMAGE_VERSION: 1.25.3-latest
  LETSENCRYPT_BASE_IMAGE_VERSION: 2.6.0-latest
  GEOSERVER_BASE_IMAGE_VERSION: 2.24.4-v2
  GEOSERVER_DATA_BASE_IMAGE_VERSION: 2.24.4-v2
  POSTGRES_BASE_IMAGE_VERSION: 15.3-latest

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # Detectar si VERSION cambi√≥
      # ------------------------------------------------------------
      - name: üîé Verificar si VERSION cambi√≥
        id: version_changed
        run: |
          if git diff --name-only HEAD~1 | grep -q '^VERSION$'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: ‚õî Abort si VERSION no cambi√≥
        if: steps.version_changed.outputs.changed != 'true'
        run: |
          echo "VERSION no cambi√≥. No es release."
          exit 0

      # ------------------------------------------------------------
      # Validaci√≥n dura del contrato
      # ------------------------------------------------------------
      - name: üîê Validar versionado
        run: |
          ./scripts/validate-version.sh

      # ------------------------------------------------------------
      # Crear tag Git (wrapper)
      # ------------------------------------------------------------
      - name: üè∑ Crear tag Git
        id: create_tag
        run: |
          VERSION=$(cat VERSION)
          TAG="v${VERSION}"

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "‚ùå El tag $TAG ya existe"
            exit 1
          fi

          git tag "$TAG"
          git push origin "$TAG"

          echo "tag=$TAG" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------
      # Login GHCR
      # ------------------------------------------------------------
      - name: üîê Login GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # ------------------------------------------------------------
      # Calcular tag can√≥nico del wrapper
      # ------------------------------------------------------------
      - name: üß© Calcular tag wrapper
        id: wrapper_tag
        run: |
          VERSION=$(cat VERSION)
          REQ_FILE="src/requirements/bundle.txt"

          GEONODE_VERSION=$(grep -E '^# GEONODE_VERSION=' "$REQ_FILE" | sed 's/# GEONODE_VERSION=//')
          SIGIC_PATCH=$(grep -E '^# SIGIC_PATCH=' "$REQ_FILE" | sed 's/# SIGIC_PATCH=//')

          if [[ "$SIGIC_PATCH" -eq 0 ]]; then
            TAG="${VERSION}+gn${GEONODE_VERSION}"
          else
            TAG="${VERSION}+gn${GEONODE_VERSION}.sigic.${SIGIC_PATCH}"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Wrapper tag: $TAG"

      # ------------------------------------------------------------
      # 1) Build & push WRAPPER (versionado)
      # ------------------------------------------------------------
      - name: üê≥ Build & push sigic_geonode
        run: |
          IMAGE="$(echo "$REGISTRY/$IMAGE_ROOT/sigic_geonode" | tr '[:upper:]' '[:lower:]')"
      
          DOCKER_TAG="$(cat .version-docker)"
          SEMVER_TAG="$(cat .version-semver)"
          VERSION=$(cat VERSION)
      
          docker build -t "$IMAGE:$DOCKER_TAG" .
          docker push "$IMAGE:$DOCKER_TAG"
      
          docker tag "$IMAGE:$DOCKER_TAG" "$IMAGE:$VERSION"
          docker tag "$IMAGE:$DOCKER_TAG" "$IMAGE:latest"
      
          docker push "$IMAGE:$VERSION"
          docker push "$IMAGE:latest"

      # ------------------------------------------------------------
      # 2) Build & push servicios auxiliares (NO versionados)
      # ------------------------------------------------------------
      - name: üß± Build & push servicios auxiliares
        run: |
          set -euo pipefail

          SERVICES=(
            nginx
            geoserver
            geoserver_data
            postgis
            letsencrypt
          )

          for SERVICE in "${SERVICES[@]}"; do
            DOCKERFILE="./docker/$SERVICE/Dockerfile"
            ENV_VAR="$(echo "${SERVICE}_BASE_IMAGE_VERSION" | tr '[:lower:]' '[:upper:]')"

            if [ -z "${!ENV_VAR:-}" ]; then
              echo "‚ùå Variable de entorno $ENV_VAR no definida"
              exit 1
            fi
            
            BASE_VERSION="${!ENV_VAR}"

            if [ ! -f "$DOCKERFILE" ]; then
              echo "Skipping $SERVICE (no Dockerfile)"
              continue
            fi

            IMAGE="$(echo "$REGISTRY/$IMAGE_ROOT/sigic_${SERVICE}" | tr '[:upper:]' '[:lower:]')"

            echo "------------------------------------------------"
            echo "Service : $SERVICE"
            echo "Tag     : $BASE_VERSION"
            echo "------------------------------------------------"

            docker build \
              --build-arg BASE_IMAGE_VERSION="$BASE_VERSION" \
              -t "$IMAGE:$BASE_VERSION" \
              "./docker/$SERVICE"

            docker push "$IMAGE:$BASE_VERSION"
          done

      # ------------------------------------------------------------
      # GitHub Release (wrapper)
      # ------------------------------------------------------------
      - name: üßæ Crear GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.create_tag.outputs.tag }}
          name: SIGIC GeoNode Wrapper ${{ steps.create_tag.outputs.tag }}
          body: |
            **Wrapper:** $(cat VERSION)
            **Imagen can√≥nica:**
            `ghcr.io/${{ github.repository }}/sigic-geonode-wrapper:${{ steps.wrapper_tag.outputs.tag }}`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
